name: Build OpenClash Overwrites

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'
  push:
    branches: [main]
    paths:
      - 'cleaner_config/**'
      - 'templates/**'
      - 'src/**'
      - '.github/workflows/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jinja2

      - name: Fetch External Configs (HenryChiao)
        run: |
          echo "ğŸ“¥ Fetching external configs..."
          mkdir -p raw_configs/external
          git clone --depth=1 https://github.com/HenryChiao/mihomo_yamls.git /tmp/upstream
          
          if [ -d "/tmp/upstream/THEYAMLS/General_Config" ]; then
            cp -r /tmp/upstream/THEYAMLS/General_Config raw_configs/external/
            echo "âœ… General_Config copied"
          fi
          
          if [ -d "/tmp/upstream/THEYAMLS/Smart_Mode" ]; then
            cp -r /tmp/upstream/THEYAMLS/Smart_Mode raw_configs/external/
            echo "âœ… Smart_Mode copied"
          fi
          
          find raw_configs/external -name "*.yaml" | wc -l
          echo "files found"

      - name: Copy Local Configs
        run: |
          echo "ğŸ“‚ Copying local configs..."
          mkdir -p raw_configs/local
          if [ -d "cleaner_config" ] && [ "$(ls -A cleaner_config)" ]; then
            cp -r cleaner_config/* raw_configs/local/
            echo "âœ… Local configs copied"
          else
            echo "â„¹ï¸ No local configs found"
          fi

      - name: Process YAML configs
        run: |
          echo "ğŸ”§ Processing YAML configs..."
          mkdir -p processed_configs/external processed_configs/local
          
          # æ£€æŸ¥Pythonè„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "src/yaml_processor.py" ]; then
            echo "âŒ Error: src/yaml_processor.py not found!"
            ls -la src/
            exit 1
          fi
          
          # å¤„ç†å¤–éƒ¨é…ç½®
          if [ -d "raw_configs/external" ]; then
            python src/yaml_processor.py \
              --input raw_configs/external \
              --output processed_configs/external \
              --recursive \
              --verbose
          fi
          
          # å¤„ç†æœ¬åœ°é…ç½®
          if [ -d "raw_configs/local" ] && [ "$(ls -A raw_configs/local)" ]; then
            python src/yaml_processor.py \
              --input raw_configs/local \
              --output processed_configs/local \
              --recursive \
              --verbose
          fi

      - name: Generate Overwrite Files
        run: |
          echo "ğŸ“ Generating overwrite files..."
          mkdir -p output/overwrites
          
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/main"
          
          # æ£€æŸ¥è„šæœ¬
          if [ ! -f "src/overwrite_generator.py" ]; then
            echo "âŒ Error: src/overwrite_generator.py not found!"
            exit 1
          fi
          
          # ç”Ÿæˆå¤–éƒ¨è¦†å†™
          if [ -d "processed_configs/external" ]; then
            python src/overwrite_generator.py \
              --input processed_configs/external \
              --output output/overwrites \
              --types main bypass smart \
              --repo-url "$REPO_URL" \
              --source external \
              --verbose || echo "Warning: External generation had issues"
          fi
          
          # ç”Ÿæˆæœ¬åœ°è¦†å†™
          if [ -d "processed_configs/local" ] && [ "$(find processed_configs/local -name '*.yaml' | wc -l)" -gt 0 ]; then
            python src/overwrite_generator.py \
              --input processed_configs/local \
              --output output/overwrites \
              --types main bypass smart \
              --repo-url "$REPO_URL" \
              --source local \
              --verbose || echo "Warning: Local generation had issues"
          fi
          
          echo "âœ… Generated files:"
          ls -la output/overwrites/ || echo "No files generated"

      - name: Generate checksums
        run: |
          cd output/overwrites
          if ls *.conf >/dev/null 2>&1; then
            sha256sum *.conf > SHA256SUMS
            echo "âœ… Checksums generated"
          else
            echo "âš ï¸ No .conf files found"
            touch SHA256SUMS
          fi
          cd ../..

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add processed_configs/ output/ -f
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-build: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… Changes pushed"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.event_name != 'pull_request'
        with:
          tag_name: release-$(date +'%Y%m%d-%H%M%S')
          name: OpenClash Overwrites $(date +'%Y-%m-%d')
          body: |
            ## ğŸ“¦ è‡ªåŠ¨ç”Ÿæˆçš„ OpenClash è¦†å†™é…ç½®
            
            ### åŒ…å«å†…å®¹
            - ç²¾ç®€åçš„ YAML é…ç½®æ–‡ä»¶
            - ä¸‰ç§æ¨¡å¼çš„è¦†å†™æ–‡ä»¶ï¼ˆä¸»è·¯ç”±/æ—è·¯ç”±/Smartï¼‰
            
            ### ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¯¹åº”çš„ `.conf` æ–‡ä»¶
            2. åœ¨ OpenClash ä¸­ä¸Šä¼ è¦†å†™æ–‡ä»¶
            3. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆæ ¹æ®provideræ•°é‡è‡ªåŠ¨è°ƒæ•´ï¼‰
          files: |
            output/overwrites/*.conf
            output/overwrites/SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
